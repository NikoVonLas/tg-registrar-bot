import { Bot, Context, InlineKeyboard, InputFile } from "grammy";
import { RegistrationStorage } from "./storage";
import { i18n } from "./i18n";
import cities from "./data/cities.json";

const storage = new RegistrationStorage();

// –¢–æ–ø-15 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
const TOP_CITIES = cities.slice(0, 15);

// Check if user is admin
function isAdmin(userId: number): boolean {
  // Bot Platform passes admins via BOT_ADMIN_IDS (comma-separated)
  const adminIds = process.env.BOT_ADMIN_IDS?.split(',').map(id => id.trim()) || [];

  // Fallback to legacy ADMIN_USER_ID for backwards compatibility
  const legacyAdminId = process.env.ADMIN_USER_ID;
  if (legacyAdminId) adminIds.push(legacyAdminId);

  return adminIds.includes(userId.toString());
}

// Callback data types
const CB = {
  LOCATION: 'use_location',
  MANUAL: 'manual_select',
  CITY: (city: string) => `city:${city}`,
  SEARCH: 'search_city',
  SEARCH_QUERY: (query: string) => `sq:${query}`,
  BACK_TO_CITIES: 'back_to_cities',
};

function createTopCitiesKeyboard() {
  const keyboard = new InlineKeyboard();

  // –ö–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥
  for (let i = 0; i < TOP_CITIES.length; i += 2) {
    keyboard.text(TOP_CITIES[i], CB.CITY(TOP_CITIES[i]));
    if (i + 1 < TOP_CITIES.length) {
      keyboard.text(TOP_CITIES[i + 1], CB.CITY(TOP_CITIES[i + 1]));
    }
    keyboard.row();
  }

  keyboard.text(i18n.t("findAnotherCity"), CB.SEARCH);

  return keyboard;
}


function createSearchResultsKeyboard(query: string) {
  const keyboard = new InlineKeyboard();

  const filtered = cities.filter(city =>
    city.toLowerCase().includes(query.toLowerCase())
  ).slice(0, 20); // –ú–∞–∫—Å–∏–º—É–º 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

  if (filtered.length === 0) {
    return null;
  }

  // –ü–æ 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥
  for (let i = 0; i < filtered.length; i += 2) {
    keyboard.text(filtered[i], CB.CITY(filtered[i]));
    if (i + 1 < filtered.length) {
      keyboard.text(filtered[i + 1], CB.CITY(filtered[i + 1]));
    }
    keyboard.row();
  }

  keyboard.text(i18n.t("backToCities"), CB.BACK_TO_CITIES);

  return keyboard;
}

async function handleCitySelection(ctx: Context, city: string) {
  if (!ctx.from) return;

  const registration = storage.register(ctx.from.id, city, {
    username: ctx.from.username,
    firstName: ctx.from.first_name,
    lastName: ctx.from.last_name,
  });

  await ctx.editMessageText(
    `–û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n\n` +
    `–í–∞—à –≥–æ—Ä–æ–¥: *${city}*\n` +
    `–í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${new Date(registration.registeredAt).toLocaleString('ru-RU')}\n\n` +
    `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ! üéâ`,
    { parse_mode: "Markdown" }
  );
}


export default function setup(bot: Bot) {
  // –ö–æ–º–∞–Ω–¥–∞ /start - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ QR-–∫–æ–¥
  bot.command("start", async (ctx) => {
    if (!ctx.from) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (storage.isRegistered(ctx.from.id)) {
      const reg = storage.getRegistration(ctx.from.id);
      await ctx.reply(
        `–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!\n\n` +
        `–í–∞—à –≥–æ—Ä–æ–¥: *${reg?.city}*\n` +
        `–í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${new Date(reg?.registeredAt || '').toLocaleString('ru-RU')}`,
        { parse_mode: "Markdown" }
      );
      return;
    }

    // –ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    await ctx.reply(
      `*–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ!*\n\n` +
      `–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥:\n\n` +
      `üìç –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º (–±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ–≥–æ)\n` +
      `–ò–ª–∏ –≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞`,
      {
        parse_mode: "Markdown",
        reply_markup: createTopCitiesKeyboard(),
      }
    );
  });


  // Callback: –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
  bot.callbackQuery(/^city:(.+)$/, async (ctx) => {
    const city = ctx.match[1];

    if (!cities.includes(city)) {
      await ctx.answerCallbackQuery({ text: "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≥–æ—Ä–æ–¥" });
      return;
    }

    await handleCitySelection(ctx, city);
    await ctx.answerCallbackQuery({ text: i18n.t("citySelected", {city}) });
  });

  // Callback: –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞
  bot.callbackQuery(CB.SEARCH, async (ctx) => {
    await ctx.editMessageText(
      `üîç *–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞*\n\n` +
      `–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞ (–º–æ–∂–Ω–æ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è).\n` +
      `–ù–∞–ø—Ä–∏–º–µ—Ä: "–ù–æ–≤–æ—Å–∏–±" –Ω–∞–π–¥—ë—Ç "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫"`,
      { parse_mode: "Markdown" }
    );
    await ctx.answerCallbackQuery();
  });

  // Callback: –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ç–æ–ø-15
  bot.callbackQuery(CB.BACK_TO_CITIES, async (ctx) => {
    await ctx.editMessageText(
      `–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö:\n\n` +
      `–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫, –µ—Å–ª–∏ –≤–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ.`,
      { reply_markup: createTopCitiesKeyboard() }
    );
    await ctx.answerCallbackQuery();
  });

  // –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞
  bot.on("message:text", async (ctx) => {
    if (!ctx.from) return;

    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if (ctx.message.text.startsWith("/")) return;

    // –ï—Å–ª–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
    if (storage.isRegistered(ctx.from.id)) {
      return;
    }

    const query = ctx.message.text.trim();

    if (query.length < 2) {
      await ctx.reply(i18n.t("enterMinChars"));
      return;
    }

    const keyboard = createSearchResultsKeyboard(query);

    if (!keyboard) {
      await ctx.reply(
        `üòû –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É "*${query}*"\n\n` +
        `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Ç–æ–ø-15.`,
        {
          parse_mode: "Markdown",
          reply_markup: new InlineKeyboard().text("‚Üê –ö —Å–ø–∏—Å–∫—É –≥–æ—Ä–æ–¥–æ–≤", CB.BACK_TO_CITIES),
        }
      );
      return;
    }

    await ctx.reply(
      `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ "*${query}*":`,
      { parse_mode: "Markdown", reply_markup: keyboard }
    );
  });

  // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  bot.command("stats", async (ctx) => {
    if (!ctx.from || !isAdmin(ctx.from.id)) {
      await ctx.reply(i18n.t("noAccess"));
      return;
    }

    const stats = storage.getStats();

    let message = `*–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π*\n\n`;
    message += `–í—Å–µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: *${stats.total}*\n\n`;
    message += `*–ü–æ –≥–æ—Ä–æ–¥–∞–º:*\n`;

    const topCities = Object.entries(stats.byCities).slice(0, 20);
    for (const [city, count] of topCities) {
      message += `‚Ä¢ ${city}: ${count}\n`;
    }

    if (Object.keys(stats.byCities).length > 20) {
      message += `\n_...–∏ –µ—â—ë ${Object.keys(stats.byCities).length - 20} –≥–æ—Ä–æ–¥–æ–≤_`;
    }

    await ctx.reply(message, { parse_mode: "Markdown" });
  });

  // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –∞–¥–º–∏–Ω–∞)
  bot.command("export", async (ctx) => {
    if (!ctx.from || !isAdmin(ctx.from.id)) {
      await ctx.reply(i18n.t("noAccess"));
      return;
    }

    const registrations = storage.getAllRegistrations();

    let csv = "UserID,Username,FirstName,LastName,City,RegisteredAt\n";
    for (const reg of registrations) {
      csv += `${reg.userId},"${reg.username || ''}","${reg.firstName || ''}","${reg.lastName || ''}","${reg.city}","${reg.registeredAt}"\n`;
    }

    await ctx.replyWithDocument(
      new InputFile(Buffer.from(csv, 'utf-8'), `registrations_${Date.now()}.csv`),
      { caption: `–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö: ${registrations.length} –∑–∞–ø–∏—Å–µ–π` }
    );
  });

  // –ü–æ–º–æ—â—å
  bot.command("help", async (ctx) => {
    await ctx.reply(
      `‚ÑπÔ∏è *–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:*\n\n` +
      `/start - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ\n` +
      `/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n` +
      `_–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:_\n` +
      `/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π\n` +
      `/export - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV`,
      { parse_mode: "Markdown" }
    );
  });
}
